name: Enhanced Security Scanning
on:
  schedule:
    - cron: '0 2 * * 1' # Weekly on Monday at 2 AM
  workflow_dispatch:
  push:
    branches: [main, develop]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    steps:
      - name: 'ðŸ“¥ Checkout code'
        uses: actions/checkout@v4

      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: 'ðŸ“¦ Install dependencies'
        run: npm ci --legacy-peer-deps

      - name: 'ðŸ” NPM Audit'
        run: |
          npm audit --audit-level=moderate || echo "::warning::NPM audit found vulnerabilities"
          npm audit --json > npm-audit-report.json || true

      - name: 'ðŸ›¡ï¸ Run Snyk Security Scan'
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -n "$SNYK_TOKEN" ]; then
            npx snyk test --severity-threshold=high || echo "::warning::Snyk found vulnerabilities"
          else
            echo "::notice::Snyk token not configured, skipping Snyk scan"
          fi

      - name: 'ðŸ”’ Container Security Scan'
        if: hashFiles('Dockerfile') != ''
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: 'ðŸ“Š OWASP Dependency Check'
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'react-app'
          path: '.'
          format: 'JSON'
          args: >
            --enableRetired
            --enableExperimental

      - name: 'ðŸ” Semgrep SAST'
        uses: returntocorp/semgrep-action@v1
        with:
          config: >
            p/security-audit
            p/owasp-top-ten
            p/javascript
            p/react

      - name: 'ðŸ“¤ Upload Security Reports'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_number }}
          path: |
            npm-audit-report.json
            trivy-results.sarif
            reports/
          retention-days: 30

      - name: 'ðŸ“ˆ Generate Security Summary'
        if: always()
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Scan Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: Completed" >> $GITHUB_STEP_SUMMARY